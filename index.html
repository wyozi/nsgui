<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<link rel="stylesheet" type="text/css" href="highlight.wiox.css">
	<style type="text/css">
		pre {
			height: 600px;
			max-height: 600px;
		}
	</style>
</head>
<body>
	<div class="col-xl-20 offset-xl-2">
		<div class="page-title">
			<h1>NSGui Customizer</h1>
			<p>A simple way to compress your NSGui installation to a single Lua file.</p>
		</div>
	</div>
	<div class="col-xl-5 offset-xl-2">
		<div id="comp-packs">
			<h2>Components</h2>
		</div>
		<div id="skin-packs">
			<h2>Skins</h2>
		</div>
		<div id="trait-packs">
			<h2>Traits</h2>
		</div>
		<div id="opts">
			<h2>Options</h2>
			<label>
				<input type="checkbox" id="opt-minify">
				<span>Minify code</span>
			</label>
		</div>
		<div id="stats">
			<h2>Stats</h2>
			<p>Code size: <span id="stat-size">0</span> bytes</p>
		</div>
		<button class="button highlighted md block" id="selectAll" onclick="javascript:selectAll()">Select all code</button>
	</div>
	<div class="col-xl-14 offset-xl-1">
		<pre id="finalcode">
		</pre>
	</div>

	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

	<script type="text/javascript" src="highlight.wiox.js"></script>

	<script type="text/javascript" src="https://cdn.jsdelivr.net/bluebird/latest/bluebird.min.js"></script>

	<script type="text/javascript" src="luaparse.js"></script>
	<script type="text/javascript" src="luamin.js"></script>
	<script type="text/javascript">
		function selectAll() {
			var el = document.getElementById("finalcode");

			var range = document.createRange();
			range.selectNodeContents(el);
			var sel = window.getSelection();
			sel.removeAllRanges();
			sel.addRange(range);
		}

		var codeCache = {};
		function fetchContents(path) {
			var d = Promise.defer();

			var cached = codeCache[path];
			if (cached) {
				d.resolve({path: path, code: cached});
			}
			else {
				$.ajax({
					url: "https://api.github.com/repos/wyozi/nsgui/contents/" + path,
					crossDomain: true,
					success: function(json) {
						var decoded = atob(json.content);
						codeCache[path] = decoded;

						d.resolve({path: path, code: decoded});
					}
				})
			}

			return d.promise;
		}

		var compPacks;
		var skinPacks;
		var traitPacks;

		fetchContents("compinfo.json").then(function(x) {
			var obj = JSON.parse(x.code);

			compPacks = {};
			skinPacks = {};
			traitPacks = {};

			function addOpt(type, packName, obj) {
				var input = $("<input>").attr("type", "checkbox").attr(type, packName);

				if (obj["default"]) {
					input.attr("disabled", "disabled").attr("checked", "checked");
				}

				var el = $("<label>").append(input).append($("<span>").text(obj.name));

				$("#" + type + "-packs").append(el).append($("<br>"));
			}

			$.each(obj.comps.groups, function(i, comp) {
				compPacks[i] = comp.files;
				addOpt("comp", i, comp);
			});
			$.each(obj.skins.groups, function(i, skin) {
				skinPacks[i] = skin.files;
				addOpt("skin", i, skin);
			});
			$.each(obj.traits.groups, function(i, trait) {
				traitPacks[i] = trait.files;
				addOpt("trait", i, trait);
			});

			refreshCode();
		});

		function indentate(code, level) {
			return code.split("\n").map(function(line) {
				return "\t" + line;
			}).join("\n");
		}

		function refreshCode() {
			var files = ["lua/nsgui/nsgui.lua", "lua/nsgui/skinbase.lua"];

			$("#comp-packs input[type='checkbox']:checked").each(function() {
				files = files.concat(compPacks[$(this).attr("comp")].map(function(comp) {
					return "lua/nsgui/comps/" + comp + ".lua";
				}));
			});
			$("#skin-packs input[type='checkbox']:checked").each(function() {
				files = files.concat(skinPacks[$(this).attr("skin")].map(function(skin) {
					return "lua/nsgui/skins/" + skin + ".lua";
				}));
			});
			$("#trait-packs input[type='checkbox']:checked").each(function() {
				files = files.concat(traitPacks[$(this).attr("trait")].map(function(trait) {
					return "lua/nsgui/traits/" + trait + ".lua";
				}));
			});
			
			Promise.all(files.map(fetchContents))
				.done(function(x) {
					var shouldMinify = $("#opt-minify").is(":checked");

					var s = "";
					for (var i in x) {
						var obj = x[i];
						s += "-- File " + obj.path + " \ndo\n";

						// We don't want to waste memory if we're gonna nuke all the whitespace anyway
						s += shouldMinify ? indentate(obj.code) : obj.code;

						s += "\nend\n";
					}

					if (shouldMinify) {
						s = luamin.minify(s);
					}

					$("#stat-size").text(s.length);

					var el = document.getElementById("finalcode");
					el.innerHTML = s;
					Highlight(el);
				});
		}

		$("body").on("click", "input[type='checkbox']", refreshCode);
	</script>
</body>
</html>